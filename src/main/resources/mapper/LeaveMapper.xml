<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myhopu.mapper.LeaveMapper">
	<resultMap id="BaseResultMap" type="com.myhopu.entity.Leave">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		<id column="LEAVE_ID" jdbcType="NUMERIC" property="leaveId" />
		<result column="LEAVE_TYPE" jdbcType="VARCHAR"
			property="leaveType" />
		<result column="TIME_START" jdbcType="TIMESTAMP"
			property="timeStart" />
		<result column="TIME_END" jdbcType="TIMESTAMP"
			property="timeEnd" />
		<result column="TIME_USED" jdbcType="NUMERIC"
			property="timeUsed" />
		<result column="USER_ID" jdbcType="NUMERIC" property="userId" />
		<result column="LEAVE_STATUS" jdbcType="NUMERIC"
			property="leaveStatus" />
	</resultMap>

	<resultMap id="BaseResultMapWithUser"
		type="com.myhopu.entity.Leave">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		<id column="LEAVE_ID" jdbcType="NUMERIC" property="leaveId" />
		<result column="LEAVE_TYPE" jdbcType="VARCHAR"
			property="leaveType" />
		<result column="TIME_START" jdbcType="TIMESTAMP"
			property="timeStart" />
		<result column="TIME_END" jdbcType="TIMESTAMP"
			property="timeEnd" />
		<result column="TIME_USED" jdbcType="NUMERIC"
			property="timeUsed" />
		<result column="USER_ID" jdbcType="NUMERIC" property="userId" />
		<result column="LEAVE_STATUS" jdbcType="NUMERIC"
			property="leaveStatus" />

		<association property="user"
			javaType="com.myhopu.entity.SysUser" autoMapping="true">
		</association>

	</resultMap>

	<sql id="Example_Where_Clause">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		<where>
			<foreach collection="oredCriteria" item="criteria"
				separator="or">
				<if test="criteria.valid">
					<trim prefix="(" prefixOverrides="and" suffix=")">
						<foreach collection="criteria.criteria" item="criterion">
							<choose>
								<when test="criterion.noValue">
									and ${criterion.condition}
								</when>
								<when test="criterion.singleValue">
									and ${criterion.condition} #{criterion.value}
								</when>
								<when test="criterion.betweenValue">
									and ${criterion.condition} #{criterion.value}
									and
									#{criterion.secondValue}
								</when>
								<when test="criterion.listValue">
									and ${criterion.condition}
									<foreach close=")" collection="criterion.value"
										item="listItem" open="(" separator=",">
										#{listItem}
									</foreach>
								</when>
							</choose>
						</foreach>
					</trim>
				</if>
			</foreach>
		</where>
	</sql>
	<sql id="Update_By_Example_Where_Clause">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		<where>
			<foreach collection="example.oredCriteria" item="criteria"
				separator="or">
				<if test="criteria.valid">
					<trim prefix="(" prefixOverrides="and" suffix=")">
						<foreach collection="criteria.criteria" item="criterion">
							<choose>
								<when test="criterion.noValue">
									and ${criterion.condition}
								</when>
								<when test="criterion.singleValue">
									and ${criterion.condition} #{criterion.value}
								</when>
								<when test="criterion.betweenValue">
									and ${criterion.condition} #{criterion.value}
									and
									#{criterion.secondValue}
								</when>
								<when test="criterion.listValue">
									and ${criterion.condition}
									<foreach close=")" collection="criterion.value"
										item="listItem" open="(" separator=",">
										#{listItem}
									</foreach>
								</when>
							</choose>
						</foreach>
					</trim>
				</if>
			</foreach>
		</where>
	</sql>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		LEAVE_ID, LEAVE_TYPE, TIME_START, TIME_END, TIME_USED, USER_ID,
		LEAVE_STATUS
	</sql>
	
	<!-- 根据员工id和年月时间来查询记录，我们需要的是已经通过的假条 -->
	<select id="selectByUseridTimeStart" resultMap="BaseResultMapWithUser">
		select * from tb_leave 
		where USER_ID = #{userid}
		and to_char(TIME_START,'yyyy/MM') = #{time}
		and LEAVE_STATUS = 5
	</select>
	
	<!-- 根据状态来查询请假记录 -->
	<select id="selectListByStatus" 
		parameterType="com.myhopu.entity.Leave"
		resultMap="BaseResultMapWithUser">
		
		 SELECT  l.*,u.*
	  		FROM tb_leave l , sys_user u
			WHERE l.USER_ID=u.USERID and LEAVE_STATUS=#{status}
	
	</select>
	
	<!-- 查询所有请假记录总数 -->
	<select id="getCountAll" resultType="java.lang.Long">
		select count(*) from tb_leave
	</select>
	
	<!-- 分页查询所有请假记录 -->
	<select id="getUserLeaveListAll" 
		parameterType="com.myhopu.entity.Leave"
		resultMap="BaseResultMapWithUser">
		select * from
		   (select a.*,rownum row_num from
		      (select * from tb_leave l , sys_user u  
		              WHERE l.USER_ID=u.USERID
		              order by l.TIME_START desc) a
		   ) b
		<![CDATA[
		where b.row_num > ${rows} * (${page}-1) and  b.row_num <= ${rows} * ${page}
		]]>
		 
	</select>
	
	<!-- 根据部门id的父部门id查询那个部门下请假人的记录数 -->
	<select id="getCountByDid" resultType="java.lang.Long">
		 select count(*) from tb_leave where USER_ID 
 		in(select USERID from sys_user 
           where DID in 
                 (select DID from sys_dept where DPID =#{dpid} ))
	</select>

	<select id="getUserLeaveListByDid"
		parameterType="com.myhopu.entity.Leave"
		resultMap="BaseResultMapWithUser">
		
		select * from
		   (select a.*,rownum row_num from
		      (select * from tb_leave l , sys_user u   where USER_ID 
		         in(select USERID from sys_user 
		                   where DID in 
		                         (select DID from sys_dept where DPID =#{dpid} ))
		        and l.USER_ID=u.USERID  
		        order by l.TIME_START desc) a
		   ) b
		<![CDATA[
		where b.row_num > ${rows} * (${page}-1) and  b.row_num <= ${rows} * ${page}
		]]>
		
	</select>

	<!-- 根据map条件查询总数量 -->
	<select id="selectCountByMapWithUser" resultType="java.lang.Long">
		SELECT count(*)
		FROM tb_leave l , sys_user u
		WHERE
		l.USER_ID=u.USERID and
		l.USER_ID=#{userId}
	</select>


	<!-- 根据userid查询请假记录，带上user信息，有分页条件 -->
	<select id="selectByMapWithUser"
		parameterType="com.myhopu.entity.Leave"
		resultMap="BaseResultMapWithUser">
		
		<!-- SELECT *
		 FROM (SELECT ROWNUM AS rowno,  l.*,u.*
		 FROM tb_leave l , sys_user u
		 WHERE l.USER_ID=u.USERID and l.USER_ID= #{userId}
		 <![CDATA[
		 AND ROWNUM <= ${rows} * ${page} ) tb_leave
		 WHERE tb_leave.rowno > ${rows} * (${page}-1)
		]]>
		order by TIME_START asc -->
		
		select * from
		   (select a.*,rownum row_num from
		      (select * from tb_leave l , sys_user u  
		              WHERE l.USER_ID=u.USERID and l.USER_ID=#{userId}
		              order by l.TIME_START desc) a
		   ) b
		<![CDATA[
		where b.row_num > ${rows} * (${page}-1) and  b.row_num <= ${rows} * ${page}
		]]>
		
		
		
	</select>

	<select id="selectByExample"
		parameterType="com.myhopu.entity.LeaveExample"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		select
		<if test="distinct">
			distinct
		</if>
		<include refid="Base_Column_List" />
		from TB_LEAVE
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>
	<select id="selectByPrimaryKey" parameterType="java.lang.Long"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		select
		<include refid="Base_Column_List" />
		from TB_LEAVE
		where LEAVE_ID = #{leaveId,jdbcType=NUMERIC}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		delete from TB_LEAVE
		where LEAVE_ID = #{leaveId,jdbcType=NUMERIC}
	</delete>
	<delete id="deleteByExample"
		parameterType="com.myhopu.entity.LeaveExample">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		delete from TB_LEAVE
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
	</delete>
	<insert id="insert" parameterType="com.myhopu.entity.Leave">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		insert into TB_LEAVE (LEAVE_ID, LEAVE_TYPE, TIME_START,
		TIME_END,
		TIME_USED, USER_ID,
		LEAVE_STATUS)
		values (#{leaveId,jdbcType=NUMERIC},
		#{leaveType,jdbcType=VARCHAR},
		#{timeStart,jdbcType=TIMESTAMP},
		#{timeEnd,jdbcType=TIMESTAMP}, #{timeUsed,jdbcType=NUMERIC},
		#{userId,jdbcType=NUMERIC},
		#{leaveStatus,jdbcType=NUMERIC})
	</insert>
	<insert id="insertSelective"
		parameterType="com.myhopu.entity.Leave">
		<selectKey keyProperty="leaveId" resultType="long"
			order="BEFORE">
			select tb_leave_sequence.nextval from dual
		</selectKey>

		insert into TB_LEAVE
		<trim prefix="(" suffix=")" suffixOverrides=",">
			LEAVE_ID,
			<!-- <if test="leaveId != null"> LEAVE_ID, </if> -->
			<if test="leaveType != null">
				LEAVE_TYPE,
			</if>
			<if test="timeStart != null">
				TIME_START,
			</if>
			<if test="timeEnd != null">
				TIME_END,
			</if>
			<if test="timeUsed != null">
				TIME_USED,
			</if>
			<if test="userId != null">
				USER_ID,
			</if>
			<if test="leaveStatus != null">
				LEAVE_STATUS,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			#{leaveId,jdbcType=NUMERIC},
			<!-- <if test="leaveId != null"> #{leaveId,jdbcType=NUMERIC}, </if> -->
			<if test="leaveType != null">
				#{leaveType,jdbcType=VARCHAR},
			</if>
			<if test="timeStart != null">
				#{timeStart,jdbcType=TIMESTAMP},
			</if>
			<if test="timeEnd != null">
				#{timeEnd,jdbcType=TIMESTAMP},
			</if>
			<if test="timeUsed != null">
				#{timeUsed,jdbcType=NUMERIC},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=NUMERIC},
			</if>
			<if test="leaveStatus != null">
				#{leaveStatus,jdbcType=NUMERIC},
			</if>
		</trim>
	</insert>
	<select id="countByExample"
		parameterType="com.myhopu.entity.LeaveExample"
		resultType="java.lang.Long">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		select count(*) from TB_LEAVE
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
	</select>
	<update id="updateByExampleSelective" parameterType="map">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		update TB_LEAVE
		<set>
			<if test="record.leaveId != null">
				LEAVE_ID = #{record.leaveId,jdbcType=NUMERIC},
			</if>
			<if test="record.leaveType != null">
				LEAVE_TYPE = #{record.leaveType,jdbcType=VARCHAR},
			</if>
			<if test="record.timeStart != null">
				TIME_START = #{record.timeStart,jdbcType=TIMESTAMP},
			</if>
			<if test="record.timeEnd != null">
				TIME_END = #{record.timeEnd,jdbcType=TIMESTAMP},
			</if>
			<if test="record.timeUsed != null">
				TIME_USED = #{record.timeUsed,jdbcType=NUMERIC},
			</if>
			<if test="record.userId != null">
				USER_ID = #{record.userId,jdbcType=NUMERIC},
			</if>
			<if test="record.leaveStatus != null">
				LEAVE_STATUS = #{record.leaveStatus,jdbcType=NUMERIC},
			</if>
		</set>
		<if test="_parameter != null">
			<include refid="Update_By_Example_Where_Clause" />
		</if>
	</update>
	<update id="updateByExample" parameterType="map">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		update TB_LEAVE
		set LEAVE_ID = #{record.leaveId,jdbcType=NUMERIC},
		LEAVE_TYPE = #{record.leaveType,jdbcType=VARCHAR},
		TIME_START =
		#{record.timeStart,jdbcType=TIMESTAMP},
		TIME_END =
		#{record.timeEnd,jdbcType=TIMESTAMP},
		TIME_USED =
		#{record.timeUsed,jdbcType=NUMERIC},
		USER_ID =
		#{record.userId,jdbcType=NUMERIC},
		LEAVE_STATUS =
		#{record.leaveStatus,jdbcType=NUMERIC}
		<if test="_parameter != null">
			<include refid="Update_By_Example_Where_Clause" />
		</if>
	</update>
	<update id="updateByPrimaryKeySelective"
		parameterType="com.myhopu.entity.Leave">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		update TB_LEAVE
		<set>
			<if test="leaveType != null">
				LEAVE_TYPE = #{leaveType,jdbcType=VARCHAR},
			</if>
			<if test="timeStart != null">
				TIME_START = #{timeStart,jdbcType=TIMESTAMP},
			</if>
			<if test="timeEnd != null">
				TIME_END = #{timeEnd,jdbcType=TIMESTAMP},
			</if>
			<if test="timeUsed != null">
				TIME_USED = #{timeUsed,jdbcType=NUMERIC},
			</if>
			<if test="userId != null">
				USER_ID = #{userId,jdbcType=NUMERIC},
			</if>
			<if test="leaveStatus != null">
				LEAVE_STATUS = #{leaveStatus,jdbcType=NUMERIC},
			</if>
		</set>
		where LEAVE_ID = #{leaveId,jdbcType=NUMERIC}
	</update>
	<update id="updateByPrimaryKey"
		parameterType="com.myhopu.entity.Leave">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Nov 13 
			14:09:01 GMT+08:00 2018. -->
		update TB_LEAVE
		set LEAVE_TYPE = #{leaveType,jdbcType=VARCHAR},
		TIME_START = #{timeStart,jdbcType=TIMESTAMP},
		TIME_END =
		#{timeEnd,jdbcType=TIMESTAMP},
		TIME_USED =
		#{timeUsed,jdbcType=NUMERIC},
		USER_ID = #{userId,jdbcType=NUMERIC},
		LEAVE_STATUS = #{leaveStatus,jdbcType=NUMERIC}
		where LEAVE_ID =
		#{leaveId,jdbcType=NUMERIC}
	</update>
</mapper>